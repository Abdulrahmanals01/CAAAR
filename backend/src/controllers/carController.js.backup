const userStatusMiddleware = require('../middleware/userStatus');
const { validationResult } = require('express-validator');
const db = require('../config/database');
const fs = require('fs');
const path = require('path');
const { formatImageUrl, normalizeImagePath } = require('../utils/imageUtils');

// Helper function to check for active bookings
const hasActiveBookings = async (carId) => {
  const currentDate = new Date().toISOString().split('T')[0]; // Today's date in YYYY-MM-DD

  const activeBookingsQuery = `
    SELECT COUNT(*) as booking_count
    FROM bookings
    WHERE car_id = $1
    AND status = 'accepted'
    AND end_date >= $2`;

  const result = await db.query(activeBookingsQuery, [carId, currentDate]);
  return result.rows[0].booking_count > 0;
};

// Create a new car listing
exports.createCar = async (req, res) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ errors: errors.array() });
  }

  try {
    const {
      brand,
      model,
      year,
      plate,
      color,
      mileage,
      price_per_day,
      location,
      latitude,
      longitude,
      availability_start,
      availability_end,
      description,
      car_type,
      features
    } = req.body;

    // Check if user is a host
    const userCheck = await db.query('SELECT role FROM users WHERE id = $1', [req.user.id]);
    if (userCheck.rows.length === 0) {
      return res.status(404).json({ message: 'User not found' });
    }

    if (userCheck.rows[0].role !== 'host' && userCheck.rows[0].role !== 'admin') {
      return res.status(403).json({ message: 'Only hosts can create car listings' });
    }

    // Handle image upload - normalize the path
    let image = null;
    if (req.file) {
      // Use our utility to normalize the path
      image = normalizeImagePath(req.file.path, 'cars');
      console.log("Normalized image path:", image);
    }

    // Check if plate number already exists
    const plateCheck = await db.query('SELECT id FROM cars WHERE plate = $1', [plate]);
    if (plateCheck.rows.length > 0) {
      return res.status(400).json({ message: 'Car with this plate number already exists' });
    }

    // Process features
    let featuresJson = null;
    if (features) {
      try {
        if (typeof features === 'string') {
          featuresJson = JSON.parse(features);
        } else {
          featuresJson = features;
        }
      } catch (e) {
        console.error('Error parsing features:', e);
        featuresJson = [];
      }
    }

    // Insert car into database with features and car_type
    const carInsert = await db.query(
      `INSERT INTO cars
      (user_id, brand, model, year, plate, color, mileage, price_per_day, location,
       latitude, longitude, availability_start, availability_end, image, description,
       car_type, features)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17)
      RETURNING *`,
      [
        req.user.id,
        brand,
        model,
        year,
        plate,
        color,
        mileage,
        price_per_day,
        location,
        latitude || null,
        longitude || null,
        availability_start,
        availability_end,
        image,
        description,
        car_type || null,
        featuresJson ? JSON.stringify(featuresJson) : '[]'
      ]
    );

    // Add image_url to the response
    const car = carInsert.rows[0];
    if (car.image) {
      car.image_url = formatImageUrl(car.image, 'cars');
    }

    res.status(201).json(car);
  } catch (err) {
    console.error('Error creating car listing:', err.message);
    res.status(500).json({ message: 'Server error while creating car listing' });
  }
};

// Get all available cars with optional filtering
exports.getCars = async (req, res) => {
  try {
    // Extract filter parameters
    const {
      location,
      brand,
      min_price,
      max_price,
      start_date,
      end_date,
      car_type,
      features
    } = req.query;

    // Start building the query
    let queryString = `
      SELECT c.id, c.brand, c.model, c.year, c.color, c.mileage,
             c.price_per_day, c.location, c.availability_start,
             c.availability_end, c.image, c.created_at, c.user_id,
             c.description, c.car_type, c.features, u.name as host_name, u.id as host_id
      FROM cars c
      JOIN users u ON c.user_id = u.id
      WHERE 1=1
    `;

    // Array to hold the parameters for the query
    const queryParams = [];
    let paramCount = 1;

    // Add filters if they exist
    if (location) {
      // Improved location matching - match at word boundaries
      queryString += ` AND (
        c.location ILIKE $${paramCount} OR
        c.location ILIKE $${paramCount + 1} OR
        c.location ILIKE $${paramCount + 2}
      )`;
      queryParams.push(`${location}%`);  // Starts with location
      queryParams.push(`% ${location}%`); // Has location after a space
      queryParams.push(`%,${location}%`); // Has location after a comma
      paramCount += 3;
    }

    if (brand) {
      queryString += ` AND c.brand ILIKE $${paramCount}`;
      queryParams.push(`%${brand}%`);
      paramCount++;
    }

    if (min_price) {
      queryString += ` AND c.price_per_day >= $${paramCount}`;
      queryParams.push(parseFloat(min_price));
      paramCount++;
    }

    if (max_price) {
      queryString += ` AND c.price_per_day <= $${paramCount}`;
      queryParams.push(parseFloat(max_price));
      paramCount++;
    }

    if (start_date && end_date) {
      queryString += ` AND c.availability_start <= $${paramCount} AND c.availability_end >= $${paramCount + 1}`;
      queryParams.push(end_date, start_date);
      paramCount += 2;
    }

    // Filter by car type
    if (car_type && car_type !== 'all') {
      queryString += ` AND c.car_type = $${paramCount}`;
      queryParams.push(car_type);
      paramCount++;
    }

    // Filter by features
    if (features) {
      let featuresArray;

      try {
        if (typeof features === 'string') {
          // Check if it's a JSON string
          if (features.startsWith('[')) {
            featuresArray = JSON.parse(features);
          } else {
            // Single feature as string
            featuresArray = [features];
          }
        } else if (Array.isArray(features)) {
          featuresArray = features;
        } else {
          featuresArray = [];
        }

        // Add feature filters
        featuresArray.forEach(feature => {
          queryString += ` AND c.features @> $${paramCount}::jsonb`;
          queryParams.push(JSON.stringify([feature]));
          paramCount++;
        });
      } catch (e) {
        console.error('Error parsing features filter:', e);
      }
    }

    // Order by creation date (newest first)
    queryString += ` ORDER BY c.created_at DESC`;

    console.log('Car query: ', queryString);
    console.log('Car query params: ', queryParams);

    const result = await db.query(queryString, queryParams);

    // Format image URLs
    const cars = result.rows.map(car => {
      if (car.image) {
        car.image_url = formatImageUrl(car.image, 'cars');
      }
      return car;
    });

    res.json(cars);
  } catch (err) {
    console.error('Error fetching cars:', err.message);
    res.status(500).json({ message: 'Server error while fetching cars' });
  }
};

// Get car by ID
exports.getCarById = async (req, res) => {
  try {
    const carId = req.params.id;

    const query = `
      SELECT c.*, u.name as host_name, u.id as host_id
      FROM cars c
      JOIN users u ON c.user_id = u.id
      WHERE c.id = $1
    `;

    const result = await db.query(query, [carId]);

    if (result.rows.length === 0) {
      return res.status(404).json({ message: 'Car not found' });
    }

    const car = result.rows[0];

    // Format image URL
    if (car.image) {
      car.image_url = formatImageUrl(car.image, 'cars');
      console.log("Car details - Generated image URL:", car.image_url);
    }

    res.json(car);
  } catch (err) {
    console.error('Error fetching car details:', err.message);
    res.status(500).json({ message: 'Server error while fetching car details' });
  }
};

// Get host's cars
exports.getHostCars = async (req, res) => {
  try {
    const hostId = req.user.id;
    console.log('Fetching cars for host ID:', hostId);

    const cars = await db.query(
      `SELECT * FROM cars WHERE user_id = $1 ORDER BY created_at DESC`,
      [hostId]
    );

    console.log(`Found ${cars.rows.length} cars for host ID ${hostId}`);

    // Format image URLs
    const formattedCars = cars.rows.map(car => {
      if (car.image) {
        car.image_url = formatImageUrl(car.image, 'cars');
      }
      return car;
    });

    res.json(formattedCars);
  } catch (err) {
    console.error('Error fetching host cars:', err.message);
    res.status(500).json({ message: 'Server error while fetching host cars' });
  }
};

// Delete a car listing
exports.deleteCar = async (req, res) => {
  try {
    const carId = req.params.id;
    const userId = req.user.id;

    // Check if car exists and belongs to the requesting user
    const carCheck = await db.query(
      'SELECT * FROM cars WHERE id = $1',
      [carId]
    );

    if (carCheck.rows.length === 0) {
      return res.status(404).json({ message: 'Car not found' });
    }

    const car = carCheck.rows[0];

    // Verify ownership (only the owner or admin can delete)
    if (car.user_id !== userId) {
      // Check if user is admin
      const userCheck = await db.query('SELECT role FROM users WHERE id = $1', [userId]);
      if (userCheck.rows[0].role !== 'admin') {
        return res.status(403).json({ message: 'Not authorized to delete this car' });
      }
    }

    // Check for active bookings
    const activeBookings = await hasActiveBookings(carId);

    if (activeBookings) {
      return res.status(400).json({
        message: 'Cannot delete car with active bookings. You must wait until all current bookings are completed.'
      });
    }

    // Delete the car from the database
    await db.query('DELETE FROM cars WHERE id = $1', [carId]);

    return res.status(200).json({ success: true, message: 'Car listing deleted successfully' });
  } catch (err) {
    console.error('Error deleting car:', err.message);
    return res.status(500).json({ message: 'Server error while deleting car listing' });
  }
};

// Update car availability
exports.updateCarAvailability = async (req, res) => {
  try {
    const carId = req.params.id;
    const { availability_start, availability_end } = req.body;
    const userId = req.user.id;

    // Input validation
    if (!availability_start || !availability_end) {
      return res.status(400).json({ message: 'Both start and end dates are required' });
    }

    // Validate date range
    if (new Date(availability_end) < new Date(availability_start)) {
      return res.status(400).json({ message: 'End date must be after start date' });
    }

    // Check if car exists and belongs to the user
    const carCheck = await db.query(
      'SELECT * FROM cars WHERE id = $1',
      [carId]
    );

    if (carCheck.rows.length === 0) {
      return res.status(404).json({ message: 'Car not found' });
    }

    const car = carCheck.rows[0];

    // Verify ownership
    if (car.user_id !== userId) {
      return res.status(403).json({ message: 'Not authorized to update this car' });
    }

    // Check for active bookings that would be affected by this date change
    const bookingConflictCheck = await db.query(
      `SELECT COUNT(*) as conflict_count
       FROM bookings
       WHERE car_id = $1
       AND status = 'accepted'
       AND (
         (start_date < $2) OR
         (end_date > $3)
       )`,
      [carId, availability_start, availability_end]
    );

    if (bookingConflictCheck.rows[0].conflict_count > 0) {
      return res.status(409).json({
        message: 'Cannot update availability: there are active bookings outside of the new date range'
      });
    }

    // Update the car's availability
    const updateResult = await db.query(
      `UPDATE cars
       SET availability_start = $1,
           availability_end = $2,
           updated_at = NOW()
       WHERE id = $3
       RETURNING *`,
      [availability_start, availability_end, carId]
    );

    const updatedCar = updateResult.rows[0];

    // Format image URL if present
    if (updatedCar.image) {
      updatedCar.image_url = formatImageUrl(updatedCar.image, 'cars');
    }

    return res.status(200).json({
      success: true,
      message: 'Car availability updated successfully',
      car: updatedCar
    });
  } catch (err) {
    console.error('Error updating car availability:', err.message);
    return res.status(500).json({ message: 'Server error while updating car availability' });
  }
};

// Check if a car has active bookings
exports.checkActiveBookings = async (req, res) => {
  try {
    const carId = req.params.id;
    const userId = req.user.id;

    // Check if car exists and belongs to the user
    const carCheck = await db.query(
      'SELECT * FROM cars WHERE id = $1',
      [carId]
    );

    if (carCheck.rows.length === 0) {
      return res.status(404).json({ message: 'Car not found' });
    }

    const car = carCheck.rows[0];

    // Verify ownership
    if (car.user_id !== userId) {
      return res.status(403).json({ message: 'Not authorized to check this car' });
    }

    // Check for active bookings
    const hasBookings = await hasActiveBookings(carId);

    return res.status(200).json({
      hasActiveBookings: hasBookings
    });
  } catch (err) {
    console.error('Error checking active bookings:', err.message);
    return res.status(500).json({ message: 'Server error while checking active bookings' });
  }
};
